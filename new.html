<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auth Image System</title>
    <style>
        label {
            width: 150px;
            display: inline-block;
        }
        input, select {
            width: 90%;
            margin-bottom: 10px;
        }
        button {
            margin-bottom: 10px;
        }
        .output {
            padding: 10px;
        }
        h2 {
            color: #2E86e1;
            margin-top: 0;
        }
        p {
            margin: 0 0 10px;
        }
        .tab-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .tab-links li {
            display: inline;
            margin-right: 10px;
        }
        .tab-content > div {
            display: none;
        }
        .tab-content > div.active {
            display: block;
        }
        .feedback-btn {
            width: 120px;
            margin: 5px;
        }
        #image_output img {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div id="auth_ui">
        <ul class="tab-links">
            <li><a href="#" data-tab="signup">Sign Up</a></li>
            <li><a href="#" data-tab="login">Login</a></li>
        </ul>
        <div class="tab-content">
            <div id="signup">
                <h2>üìù Sign Up</h2>
                <p>Create a new account with your industry code</p>
                <label>Username:</label><input id="signup_username" type="text"><br>
                <label>Password:</label><input id="signup_password" type="password"><br>
                <label>Industry Code:</label><input id="industry_code" type="text" placeholder="Enter your industry code (e.g., TECH-123)"><br>
                <label>Template:</label><select id="template_dropdown" disabled><option value="null">None</option></select><br>
                <div style="font-size:12px; color:#666; margin-top:-10px">Enter your industry-specific code for future features</div>
                <button id="signup_btn" style="width:200px; background:#007bff; color:white;">Create Account</button>
                <div id="signup_status" class="output"></div>
            </div>
            <div id="login">
                <h2>üîí Login</h2>
                <p>Access your existing account</p>
                <label>Username:</label><input id="login_username" type="text"><br>
                <label>Password:</label><input id="login_password" type="password"><br>
                <button id="login_btn" style="width:200px; background:#007bff; color:white;">Login</button>
                <div id="login_status" class="output"></div>
            </div>
        </div>
    </div>
    <div id="post_login_ui" style="display:none;">
        <!-- Filled dynamically -->
    </div>
    <script>
        // Tab switching
        const tabLinks = document.querySelectorAll('.tab-links a');
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const tabId = link.dataset.tab;
                document.querySelectorAll('.tab-content > div').forEach(d => d.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            });
        });
        // Trigger first tab
        tabLinks[0].click();
        // UserManager
        class UserManager {
            constructor() {
                this.USER_DB_KEY = "user_database";
                this.TEMPLATE_DB_KEY = "templates";
                this.MASTER_USERNAME = "master123";
                this.DEFAULT_MASTER_PASSWORD = "master@123";
                this.users = JSON.parse(localStorage.getItem(this.USER_DB_KEY)) || {};
                this.templates = JSON.parse(localStorage.getItem(this.TEMPLATE_DB_KEY)) || {};
                this.current_user = null;
                this.current_role = null;
                this.create_master_user();
            }
            async create_master_user() {
                if (!this.users[this.MASTER_USERNAME]) {
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const hashed_pw = await this.hashPassword(this.DEFAULT_MASTER_PASSWORD, salt);
                    this.users[this.MASTER_USERNAME] = {
                        "password": this.arrayBufferToHex(hashed_pw),
                        "salt": this.arrayBufferToHex(salt),
                        "industry_code": "ADMIN-001",
                        "role": "master",
                        "created_at": new Date().toISOString().slice(0,19).replace('T',' '),
                        "template_id": null
                    };
                    this.save_users();
                }
            }
            save_users() {
                localStorage.setItem(this.USER_DB_KEY, JSON.stringify(this.users));
            }
            save_templates() {
                localStorage.setItem(this.TEMPLATE_DB_KEY, JSON.stringify(this.templates));
            }
            async hashPassword(password, salt) {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    "raw",
                    encoder.encode(password),
                    { name: "PBKDF2" },
                    false,
                    ["deriveBits"]
                );
                const hash = await crypto.subtle.deriveBits(
                    {
                        name: "PBKDF2",
                        salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    keyMaterial,
                    256
                );
                return hash;
            }
            arrayBufferToHex(buffer) {
                return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            async create_user(username, password, industry_code, template_id = null) {
                if (this.users[username]) return {success: false, message: "Username already exists"};
                const role = username === this.MASTER_USERNAME ? "master" : "client";
                if (template_id && !this.templates[template_id]) return {success: false, message: "Invalid template ID"};
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const hashed_pw = await this.hashPassword(password, salt);
                this.users[username] = {
                    "password": this.arrayBufferToHex(hashed_pw),
                    "salt": this.arrayBufferToHex(salt),
                    "industry_code": industry_code,
                    "role": role,
                    "created_at": new Date().toISOString().slice(0,19).replace('T',' '),
                    "template_id": template_id
                };
                this.save_users();
                return {success: true, message: `Account created successfully. Role: ${role}`};
            }
            async authenticate(username, password) {
                if (!this.users[username]) return {success: false, message: "User not found"};
                const user = this.users[username];
                const saltHex = user["salt"];
                const salt = Uint8Array.from(saltHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const hashed_pw = await this.hashPassword(password, salt);
                if (this.arrayBufferToHex(hashed_pw) !== user["password"]) return {success: false, message: "Invalid password"};
                this.current_user = username;
                this.current_role = user["role"];
                return {success: true, message: `Login successful. Role: ${user["role"]}`};
            }
            logout() {
                this.current_user = null;
                this.current_role = null;
                return "You have been logged out";
            }
            create_template(template_name, industry_code, content, creator) {
                if (creator !== this.MASTER_USERNAME || this.current_role !== "master") return {success: false, message: "Only master users can create templates"};
                const template_id = crypto.randomUUID();
                this.templates[template_id] = {
                    "name": template_name,
                    "industry_code": industry_code,
                    "content": content,
                    "created_at": new Date().toISOString().slice(0,19).replace('T',' ')
                };
                this.save_templates();
                return {success: true, message: `Template '${template_name}' created with ID: ${template_id}`};
            }
            delete_template(template_id, user) {
                if (user !== this.MASTER_USERNAME || this.current_role !== "master") return {success: false, message: "Only master users can delete templates"};
                if (!this.templates[template_id]) return {success: false, message: "Template not found"};
                for (const u in this.users) {
                    if (this.users[u].template_id === template_id) return {success: false, message: "Template is assigned to users and cannot be deleted"};
                }
                delete this.templates[template_id];
                this.save_templates();
                return {success: true, message: `Template ${template_id} deleted successfully`};
            }
            get_templates_by_industry(industry_code) {
                const matching = {};
                for (const tid in this.templates) {
                    if (this.templates[tid].industry_code === industry_code) matching[tid] = this.templates[tid];
                }
                return matching;
            }
        }
        // Image functions
        async function getPollinationsImage(prompt) {
            try {
                const seed = Math.floor(Math.random() * 1000000);
                const encoded_prompt = encodeURIComponent(prompt);
                const api_url = `https://image.pollinations.ai/prompt/${encoded_prompt}?seed=${seed}&width=1024&height=1024`;
                const response = await fetch(api_url, {timeout: 60000});
                if (!response.ok) throw new Error('Failed');
                const blob = await response.blob();
                return blob;
            } catch (e) {
                console.log(`Image generation failed: ${e}`);
                return null;
            }
        }
        async function generateTwoImages(subject, style = "professional photography") {
            const base_prompt = `A photorealistic 1024x1024 image of ${subject}, ${style}, high quality, 8k`;
            const images = [];
            for (let i = 0; i < 2; i++) {
                const variation_prompt = `${base_prompt}, variation ${i+1}, unique composition`;
                const img_blob = await getPollinationsImage(variation_prompt);
                images.push(img_blob);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            return images;
        }
        // AuthImageSystem
        class AuthImageSystem {
            constructor() {
                this.user_manager = new UserManager();
                this.current_images = [];
                this.current_subject = "";
                this.current_style = "";
                this.regeneration_count = 0;
                this.MAX_REGENERATIONS = 20;
                this.attachHandlers();
            }
            attachHandlers() {
                document.getElementById('signup_btn').addEventListener('click', async () => this.on_signup());
                document.getElementById('login_btn').addEventListener('click', async () => this.on_login());
                document.getElementById('industry_code').addEventListener('input', (e) => this.update_template_dropdown(e.target.value));
            }
            update_template_dropdown(industry_code) {
                industry_code = industry_code.trim();
                const templates = this.user_manager.get_templates_by_industry(industry_code);
                let options = '<option value="null">None</option>';
                for (const tid in templates) {
                    options += `<option value="${tid}">${templates[tid].name}</option>`;
                }
                const dropdown = document.getElementById('template_dropdown');
                dropdown.innerHTML = options;
                dropdown.disabled = Object.keys(templates).length === 0;
            }
            async on_signup() {
                const username = document.getElementById('signup_username').value.trim();
                const password = document.getElementById('signup_password').value.trim();
                const industry_code = document.getElementById('industry_code').value.trim();
                const template_id = document.getElementById('template_dropdown').value === 'null' ? null : document.getElementById('template_dropdown').value;
                const status = document.getElementById('signup_status');
                status.innerHTML = '';
                if (!username || !password) {
                    status.innerHTML = `<div style="color:red">Username and password are required!</div>`;
                    return;
                }
                if (!industry_code) {
                    status.innerHTML = `<div style="color:red">Industry code is required!</div>`;
                    return;
                }
                const {success, message} = await this.user_manager.create_user(username, password, industry_code, template_id);
                const color = success ? "green" : "red";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
            }
            async on_login() {
                const username = document.getElementById('login_username').value.trim();
                const password = document.getElementById('login_password').value.trim();
                const status = document.getElementById('login_status');
                status.innerHTML = '';
                if (!username || !password) {
                    status.innerHTML = `<div style="color:red">Username and password required!</div>`;
                    return;
                }
                const {success, message} = await this.user_manager.authenticate(username, password);
                const color = success ? "green" : "red";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
                if (success) {
                    setTimeout(() => {
                        document.getElementById('auth_ui').style.display = 'none';
                        this.show_post_login_ui();
                    }, 3000);
                }
            }
            show_post_login_ui() {
                const container = document.getElementById('post_login_ui');
                container.style.display = 'block';
                const role = this.user_manager.current_role;
                const username = this.user_manager.current_user;
                let html = `
                    <div style="display: flex; justify-content: space-between;">
                        <h2 style="margin:0; flex-grow:1">Logged in as: ${username} (${role})</h2>
                        <button id="logout_btn" style="width:100px; background:#ffc107; color:black;">Logout</button>
                    </div>
                `;
                if (role === "master") {
                    html += `
                        <ul class="tab-links">
                            <li><a href="#" data-tab="image_gen">Image Generator</a></li>
                            <li><a href="#" data-tab="template_mgmt">Template Management</a></li>
                        </ul>
                        <div class="tab-content">
                            ${this.get_image_gen_html()}
                            ${this.get_template_mgmt_html()}
                        </div>
                    `;
                } else {
                    html += this.get_image_gen_html();
                }
                container.innerHTML = html;
                document.getElementById('logout_btn').addEventListener('click', () => this.on_logout());
                if (role === "master") {
                    const postTabLinks = container.querySelectorAll('.tab-links a');
                    postTabLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            postTabLinks.forEach(l => l.classList.remove('active'));
                            link.classList.add('active');
                            container.querySelectorAll('.tab-content > div').forEach(d => d.classList.remove('active'));
                            container.querySelector(`#${link.dataset.tab}`).classList.add('active');
                        });
                    });
                    postTabLinks[0].click();
                    document.getElementById('create_template_btn').addEventListener('click', () => this.on_create_template());
                    document.getElementById('delete_template_btn').addEventListener('click', () => this.on_delete_template());
                    this.update_template_delete_dropdown();
                }
                document.getElementById('generate_btn').addEventListener('click', async () => this.on_generate());
                const template_id = this.user_manager.users[this.user_manager.current_user].template_id;
                if (template_id && this.user_manager.templates[template_id]) {
                    document.getElementById('image_style').value = this.user_manager.templates[template_id].content;
                }
            }
            get_image_gen_html() {
                return `
                    <div id="image_gen" class="active">
                        <h2>üñºÔ∏è Image Generator</h2>
                        <p>Enter a subject and style to generate two images</p>
                        <label>Subject:</label><input id="image_subject" type="text" placeholder="e.g., Spicy Tuna Roll, Mystery Novel, Smart Watch"><br>
                        <label>Style:</label><input id="image_style" type="text" value="professional photography"><br>
                        <button id="generate_btn" style="width:200px; background:#007bff; color:white;">Generate Images</button>
                        <div id="image_output" class="output"></div>
                        <div id="feedback_status" class="output"></div>
                    </div>
                `;
            }
            get_template_mgmt_html() {
                return `
                    <div id="template_mgmt">
                        <h2>üõ†Ô∏è Template Management</h2>
                        <p>Create or delete industry-specific templates (Master only)</p>
                        <label>Template Name:</label><input id="template_name" type="text"><br>
                        <label>Industry Code:</label><input id="template_industry_code" type="text"><br>
                        <label>Content:</label><input id="template_content" type="text" placeholder="e.g., professional photography, Japanese cuisine"><br>
                        <button id="create_template_btn" style="width:200px; background:#007bff; color:white;">Create Template</button>
                        <label>Delete Template:</label><select id="delete_template_dropdown"><option value="null">Select a template</option></select><br>
                        <button id="delete_template_btn" style="width:200px; background:#dc3545; color:white;">Delete Template</button>
                        <div id="template_status" class="output"></div>
                    </div>
                `;
            }
            on_logout() {
                const message = this.user_manager.logout();
                const container = document.getElementById('post_login_ui');
                container.innerHTML = `<div style="color:blue;padding:10px">${message}</div>`;
                setTimeout(() => {
                    container.style.display = 'none';
                    document.getElementById('auth_ui').style.display = 'block';
                }, 2000);
            }
            on_create_template() {
                if (this.user_manager.current_role !== "master") {
                    document.getElementById('template_status').innerHTML = `<div style="color:red">Only master users can create templates!</div>`;
                    return;
                }
                const template_name = document.getElementById('template_name').value.trim();
                const industry_code = document.getElementById('template_industry_code').value.trim();
                const content = document.getElementById('template_content').value.trim();
                const status = document.getElementById('template_status');
                status.innerHTML = '';
                if (!template_name || !industry_code || !content) {
                    status.innerHTML = `<div style="color:red">All template fields are required!</div>`;
                    return;
                }
                const {success, message} = this.user_manager.create_template(template_name, industry_code, content, this.user_manager.current_user);
                const color = success ? "green" : "red";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
                this.update_template_delete_dropdown();
            }
            on_delete_template() {
                if (this.user_manager.current_role !== "master") {
                    document.getElementById('template_status').innerHTML = `<div style="color:red">Only master users can delete templates!</div>`;
                    return;
                }
                const template_id = document.getElementById('delete_template_dropdown').value;
                const status = document.getElementById('template_status');
                status.innerHTML = '';
                if (!template_id || template_id === 'null') {
                    status.innerHTML = `<div style="color:red">Select a template to delete!</div>`;
                    return;
                }
                const {success, message} = this.user_manager.delete_template(template_id, this.user_manager.current_user);
                const color = success ? "green" : "red";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
                this.update_template_delete_dropdown();
            }
            update_template_delete_dropdown() {
                const templates = this.user_manager.templates;
                let options = '<option value="null">Select a template</option>';
                for (const tid in templates) {
                    const t = templates[tid];
                    options += `<option value="${tid}">${t.name} (${t.industry_code})</option>`;
                }
                document.getElementById('delete_template_dropdown').innerHTML = options;
            }
            async on_generate() {
                const subject = document.getElementById('image_subject').value.trim();
                const style = document.getElementById('image_style').value.trim();
                const output = document.getElementById('image_output');
                output.innerHTML = '';
                if (!subject) {
                    output.innerHTML = `<div style="color:red">Subject is required!</div>`;
                    return;
                }
                this.regeneration_count = 0;
                this.current_subject = subject;
                this.current_style = style;
                output.innerHTML = `<div style="color:blue">Generating images, please wait...</div>`;
                await this.generate_and_display_images();
            }
            async generate_and_display_images() {
                const output = document.getElementById('image_output');
                const images = await generateTwoImages(this.current_subject, this.current_style);
                this.current_images = images;
                output.innerHTML = '';
                if (images.every(img => img === null)) {
                    output.innerHTML += `<div style="color:red">Failed to generate images.</div>`;
                    return;
                }
                images.forEach((img, i) => {
                    if (img) {
                        const url = URL.createObjectURL(img);
                        output.innerHTML += `<h3>Image ${i+1}</h3><img src="${url}" alt="Generated Image ${i+1}">`;
                    }
                });
                output.innerHTML += `
                    <div>
                        <button id="like_this_btn" class="feedback-btn" style="background:#28a745; color:white;">I like this</button>
                        <button id="like_that_btn" class="feedback-btn" style="background:#28a745; color:white;">I like that</button>
                        <button id="both_bad_btn" class="feedback-btn" style="background:#dc3545; color:white;">Both bad</button>
                    </div>
                `;
                if (this.regeneration_count > 0) {
                    output.innerHTML += `<div style="color:blue">Regeneration attempt: ${this.regeneration_count}/${this.MAX_REGENERATIONS}</div>`;
                }
                document.getElementById('like_this_btn').addEventListener('click', () => this.on_like_this());
                document.getElementById('like_that_btn').addEventListener('click', () => this.on_like_that());
                document.getElementById('both_bad_btn').addEventListener('click', () => this.on_both_bad());
            }
            async on_like_this() {
                if (this.current_images.length > 0 && this.current_images[0]) {
                    const filename = `${this.current_subject.replace(/ /g, '_')}_1.png`;
                    const html = await this.download_image(this.current_images[0], filename);
                    document.getElementById('feedback_status').innerHTML = `<div style="color:green;padding:10px">${html}</div>`;
                }
            }
            async on_like_that() {
                if (this.current_images.length > 1 && this.current_images[1]) {
                    const filename = `${this.current_subject.replace(/ /g, '_')}_2.png`;
                    const html = await this.download_image(this.current_images[1], filename);
                    document.getElementById('feedback_status').innerHTML = `<div style="color:green;padding:10px">${html}</div>`;
                }
            }
            async on_both_bad() {
                this.regeneration_count += 1;
                const output = document.getElementById('image_output');
                if (this.regeneration_count >= this.MAX_REGENERATIONS) {
                    output.innerHTML = `<div style="color:red">Maximum regenerations reached. Please try a different subject.</div>`;
                    return;
                }
                output.innerHTML = `<div style="color:blue">Regenerating images (attempt ${this.regeneration_count}/${this.MAX_REGENERATIONS})...</div>`;
                await this.generate_and_display_images();
            }
            async download_image(img_blob, filename) {
                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = () => {
                        const b64 = reader.result.split(',')[1];
                        const html = `
                            <a download="${filename}" href="data:image/png;base64,${b64}" target="_blank">
                                Click to download ${filename}
                            </a>
                        `;
                        resolve(html);
                    };
                    reader.readAsDataURL(img_blob);
                });
            }
        }
        const auth_image_system = new AuthImageSystem();
    </script>
</body>
</html>
